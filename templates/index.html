{% extends "base.html" %}

{% block title %}纽约时报畅销书排行榜 - BookRank{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">
        <i class="fa fa-fire text-gold"></i>
        纽约时报畅销书排行榜
    </h1>
    <p class="page-subtitle">
        <i class="fa fa-clock-o"></i>
        更新于: {{ update_time if update_time else '刚刚' }}
    </p>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-group">
        <label class="filter-label">图书分类</label>
        <select class="filter-select" id="category-select" onchange="changeCategory(this.value)">
            {% for cat in categories %}
            <option value="{{ cat.value }}" {% if cat.value == current_category %}selected{% endif %}>
                {{ cat.label }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group search-box">
        <label class="filter-label">搜索</label>
        <div class="search-input-wrapper">
            <input type="text" 
                   class="filter-input" 
                   id="search-input"
                   placeholder="搜索书名或作者..."
                   value="{{ search_query if search_query else '' }}">
            <i class="fa fa-search"></i>
        </div>
    </div>
    
    <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fa fa-filter"></i>
            筛选
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()">
            <i class="fa fa-refresh"></i>
            重置
        </button>
    </div>
    
    <div class="view-toggle">
        <button class="btn btn-icon {% if view_mode == 'grid' or not view_mode %}active{% endif %}" 
                id="view-grid"
                onclick="toggleView('grid')"
                title="网格视图">
            <i class="fa fa-th"></i>
        </button>
        <button class="btn btn-icon {% if view_mode == 'list' %}active{% endif %}" 
                id="view-list"
                onclick="toggleView('list')"
                title="列表视图">
            <i class="fa fa-list"></i>
        </button>
    </div>
</div>

<!-- Books Grid View -->
<div class="books-grid" id="books-grid" style="display: {% if view_mode == 'grid' or not view_mode %}grid{% else %}none{% endif %}">
    {% for book in books %}
    <div class="card card-animate" style="animation-delay: {{ loop.index * 0.05 }}s">
        <div class="card-image">
            <img src="{{ book.cover_url if book.cover_url else url_for('static', filename='default-cover.png') }}" 
                 alt="{{ book.title }}"
                 loading="lazy"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
            
            <!-- Rank Badge -->
            <div class="card-badge {% if loop.index == 1 %}gold{% elif loop.index == 2 %}silver{% elif loop.index == 3 %}bronze{% else %}other{% endif %}">
                {{ loop.index }}
            </div>
            
            <!-- Favorite Button -->
            <button class="card-favorite" onclick="toggleFavorite(this, '{{ book.isbn13 }}')">
                <i class="fa fa-heart-o"></i>
            </button>
        </div>
        
        <div class="card-content">
            <h3 class="card-title" title="{{ book.title }}">{{ book.title }}</h3>
            <p class="card-author">{{ book.author }}</p>
            
            <div class="card-meta">
                <span class="card-tag">{{ book.category if book.category else '虚构类' }}</span>
                {% if book.weeks_on_list %}
                <span class="card-tag">
                    <i class="fa fa-clock-o"></i> {{ book.weeks_on_list }}周
                </span>
                {% endif %}
            </div>
            
            {% if book.description %}
            <p class="card-desc">{{ book.description[:100] }}{% if book.description|length > 100 %}...{% endif %}</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Books List View -->
<div class="books-list" id="books-list" style="display: {% if view_mode == 'list' %}flex{% else %}none{% endif %}">
    {% for book in books %}
    <div class="list-item card-animate" style="animation-delay: {{ loop.index * 0.05 }}s">
        <div class="list-item-image">
            <img src="{{ book.cover_url if book.cover_url else url_for('static', filename='default-cover.png') }}" 
                 alt="{{ book.title }}"
                 loading="lazy"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
        </div>
        
        <div class="list-item-content">
            <div class="list-item-header">
                <div class="list-item-rank {% if loop.index == 1 %}rank-gold{% elif loop.index == 2 %}rank-silver{% elif loop.index == 3 %}rank-bronze{% endif %}">
                    {{ loop.index }}
                </div>
                <h3 class="list-item-title">{{ book.title }}</h3>
            </div>
            
            <p class="list-item-author">{{ book.author }}</p>
            
            {% if book.description %}
            <p class="list-item-desc">{{ book.description }}</p>
            {% endif %}
            
            <div class="list-item-meta">
                <span class="card-tag">{{ book.category if book.category else '虚构类' }}</span>
                {% if book.weeks_on_list %}
                <span class="card-tag">
                    <i class="fa fa-clock-o"></i> {{ book.weeks_on_list }}周
                </span>
                {% endif %}
                {% if book.publisher %}
                <span class="card-tag">
                    <i class="fa fa-building"></i> {{ book.publisher }}
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="list-item-actions">
            <button class="btn btn-icon btn-outline" onclick="toggleFavorite(this, '{{ book.isbn13 }}')">
                <i class="fa fa-heart-o"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
{% if not books %}
<div class="empty-state">
    <i class="fa fa-inbox"></i>
    <h3>暂无数据</h3>
    <p>请尝试切换分类或稍后重试</p>
</div>
{% endif %}

<!-- Quick Link to Awards -->
<div class="quick-link-section">
    <a href="{{ url_for('main.awards') }}" class="quick-link-card">
        <i class="fa fa-trophy"></i>
        <div>
            <h4>查看国际图书奖项榜单</h4>
            <p>诺贝尔文学奖、布克奖、普利策奖等</p>
        </div>
        <i class="fa fa-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Change category
    function changeCategory(category) {
        showLoading('加载中...');
        window.location.href = `/?category=${category}`;
    }
    
    // Apply filters
    function applyFilters() {
        const category = document.getElementById('category-select').value;
        const search = document.getElementById('search-input').value;
        
        showLoading('搜索中...');
        
        let url = `/?category=${category}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        window.location.href = url;
    }
    
    // Clear
{% extends "base.html" %}

{% block og_title %}纽约时报畅销书排行榜 - BookRank{% endblock %}
{% block twitter_title %}纽约时报畅销书排行榜 - BookRank{% endblock %}

{% block title %}纽约时报畅销书排行榜 - BookRank{% endblock %}

{% block content %}
<!-- Page Header -->
<header class="page-header">
    <h1 class="page-title">
        <i class="fa fa-fire text-gold" aria-hidden="true"></i>
        纽约时报畅销书排行榜
    </h1>
    <p class="page-subtitle">
        <i class="fa fa-clock-o" aria-hidden="true"></i>
        <time datetime="{{ update_time if update_time else '' }}">更新于: {{ update_time if update_time else '刚刚' }}</time>
        {% if is_cached %}
        <span class="cache-badge">缓存数据</span>
        {% endif %}
    </p>
</header>

<!-- Filter Bar -->
<section class="filter-bar" aria-label="筛选选项">
    <div class="filter-group">
        <label class="filter-label" for="category-select">图书分类</label>
        <select class="filter-select" id="category-select" onchange="changeCategory(this.value)">
            {% for key, label in categories.items() %}
            <option value="{{ key }}" {% if key == current_category %}selected{% endif %}>
                {{ label }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="filter-group search-box">
        <label class="filter-label" for="search-input">搜索</label>
        <div class="search-input-wrapper">
            <input type="search"
                   class="filter-input"
                   id="search-input"
                   placeholder="搜索书名或作者..."
                   value="{{ search_query if search_query else '' }}"
                   aria-label="搜索书名或作者">
            <i class="fa fa-search" aria-hidden="true"></i>
        </div>
    </div>

    <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()" aria-label="应用筛选">
            <i class="fa fa-filter" aria-hidden="true"></i>
            筛选
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()" aria-label="重置筛选">
            <i class="fa fa-refresh" aria-hidden="true"></i>
            重置
        </button>
    </div>

    <div class="view-toggle" role="group" aria-label="视图切换">
        <button class="btn btn-icon {% if view_mode == 'grid' %}active{% endif %}"
                id="view-grid"
                onclick="toggleView('grid')"
                title="网格视图"
                aria-label="切换到网格视图"
                aria-pressed="{% if view_mode == 'grid' %}true{% else %}false{% endif %}">
            <i class="fa fa-th" aria-hidden="true"></i>
        </button>
        <button class="btn btn-icon {% if view_mode == 'list' or not view_mode %}active{% endif %}"
                id="view-list"
                onclick="toggleView('list')"
                title="列表视图"
                aria-label="切换到列表视图"
                aria-pressed="{% if view_mode == 'list' or not view_mode %}true{% else %}false{% endif %}">
            <i class="fa fa-list" aria-hidden="true"></i>
        </button>
    </div>
</section>

<!-- Export Actions Bar -->
{% if books %}
<section class="export-actions-bar" aria-label="导出选项">
    <span class="export-info">共 <strong>{{ books|length }}</strong> 本图书</span>
    <div class="export-buttons">
        <button class="btn btn-primary btn-sm" onclick="exportBooks('{{ current_category }}')" aria-label="导出当前分类">
            <i class="fa fa-download" aria-hidden="true"></i>
            导出当前分类
        </button>
        <button class="btn btn-secondary btn-sm" onclick="exportBooks('all')" aria-label="导出全部">
            <i class="fa fa-download" aria-hidden="true"></i>
            导出全部
        </button>
    </div>
</section>
{% endif %}

<!-- Books Grid View -->
<section class="books-grid" id="books-grid" style="display: {% if view_mode == 'grid' %}grid{% else %}none{% endif %}" aria-label="图书网格视图">
    {% for book in books %}
    <article class="card card-animate" style="animation-delay: {{ loop.index * 0.05 }}s"
             onclick="openBookModal({{ loop.index - 1 }})"
             role="button"
             tabindex="0"
             aria-label="{{ book.title }} - 第{{ loop.index }}名">
        <div class="card-image">
            <img src="{{ book.cover if book.cover else url_for('static', filename='default-cover.png') }}"
                 alt="{{ book.title }}封面"
                 loading="lazy"
                 width="280"
                 height="240"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">

            <!-- Category Tag -->
            <span class="card-category-tag">{{ book.category_name if book.category_name else '虚构类' }}</span>

            <!-- Rank Badge -->
            <span class="card-badge {% if loop.index == 1 %}gold{% elif loop.index == 2 %}silver{% elif loop.index == 3 %}bronze{% else %}other{% endif %}"
                  aria-label="排名: 第{{ loop.index }}名">
                {{ loop.index }}
            </span>

            <!-- Rank Change Badge -->
            {% if book.rank_last_week and book.rank_last_week != '0' %}
                {% set rank_change = book.rank_last_week|int - loop.index %}
                {% if rank_change > 0 %}
                <span class="rank-change up" aria-label="排名上升{{ rank_change }}名">+{{ rank_change }}</span>
                {% elif rank_change < 0 %}
                <span class="rank-change down" aria-label="排名下降{{ rank_change|abs }}名">-{{ rank_change|abs }}</span>
                {% endif %}
            {% elif book.rank_last_week == '0' or not book.rank_last_week %}
                <span class="rank-change new" aria-label="新书上榜">NEW</span>
            {% endif %}
        </div>

        <div class="card-content">
            <div class="card-rank-row">
                <span class="card-rank-badge">第{{ loop.index }}名</span>
                {% if book.weeks_on_list %}
                <span class="card-weeks">
                    <i class="fa fa-clock-o" aria-hidden="true"></i> {{ book.weeks_on_list }}周
                </span>
                {% endif %}
            </div>
            <h3 class="card-title" title="{{ book.title }}">{{ book.title }}</h3>
            <p class="card-author">{{ book.author }}</p>
            {% if book.isbn13 %}
            <p class="card-isbn">ISBN: {{ book.isbn13 }}</p>
            {% elif book.isbn10 %}
            <p class="card-isbn">ISBN: {{ book.isbn10 }}</p>
            {% endif %}

            {% if book.description %}
            <p class="card-desc">{{ book.description[:100] }}{% if book.description|length > 100 %}...{% endif %}</p>
            {% endif %}
        </div>
    </article>
    {% endfor %}
</section>

<!-- Books List View -->
<section class="books-list" id="books-list" style="display: {% if view_mode == 'list' or not view_mode %}flex{% else %}none{% endif %}" aria-label="图书列表视图">
    {% for book in books %}
    <article class="list-item card-animate" style="animation-delay: {{ loop.index * 0.05 }}s"
             onclick="openBookModal({{ loop.index - 1 }})"
             role="button"
             tabindex="0"
             aria-label="{{ book.title }} - 第{{ loop.index }}名">
        <div class="list-item-image">
            <img src="{{ book.cover if book.cover else url_for('static', filename='default-cover.png') }}"
                 alt="{{ book.title }}封面"
                 loading="lazy"
                 width="100"
                 height="150"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
        </div>

        <div class="list-item-content">
            <div class="list-item-header">
                <span class="list-item-rank {% if loop.index == 1 %}rank-gold{% elif loop.index == 2 %}rank-silver{% elif loop.index == 3 %}rank-bronze{% endif %}"
                      aria-label="第{{ loop.index }}名">
                    {{ loop.index }}
                </span>

                <!-- Rank Change -->
                {% if book.rank_last_week and book.rank_last_week != '0' %}
                    {% set rank_change = book.rank_last_week|int - loop.index %}
                    {% if rank_change > 0 %}
                    <span class="rank-change-badge up" aria-label="上升{{ rank_change }}名">+{{ rank_change }}</span>
                    {% elif rank_change < 0 %}
                    <span class="rank-change-badge down" aria-label="下降{{ rank_change|abs }}名">-{{ rank_change|abs }}</span>
                    {% endif %}
                {% elif book.rank_last_week == '0' or not book.rank_last_week %}
                    <span class="rank-change-badge new" aria-label="新书上榜">NEW</span>
                {% endif %}

                <h3 class="list-item-title">{{ book.title }}</h3>
            </div>

            <p class="list-item-author">{{ book.author }}</p>

            {% if book.description %}
            <p class="list-item-desc">{{ book.description[:200] }}{% if book.description|length > 200 %}...{% endif %}</p>
            {% endif %}

            <div class="list-item-meta">
                <span class="card-tag">{{ book.category_name if book.category_name else '虚构类' }}</span>
                {% if book.weeks_on_list %}
                <span class="card-tag">
                    <i class="fa fa-clock-o" aria-hidden="true"></i> {{ book.weeks_on_list }}周
                </span>
                {% endif %}
                {% if book.publisher %}
                <span class="card-tag">
                    <i class="fa fa-building" aria-hidden="true"></i> {{ book.publisher }}
                </span>
                {% endif %}
            </div>
        </div>

        <div class="list-item-actions">
            <button class="btn btn-icon btn-outline"
                    onclick="event.stopPropagation(); toggleFavorite(this, '{{ book.isbn13 }}')"
                    aria-label="收藏 {{ book.title }}"
                    aria-pressed="false">
                <i class="fa fa-heart-o" aria-hidden="true"></i>
            </button>
        </div>
    </article>
    {% endfor %}
</section>

<!-- Empty State -->
{% if not books %}
<section class="empty-state" aria-label="暂无数据">
    <i class="fa fa-inbox" aria-hidden="true"></i>
    <h2>暂无数据</h2>
    <p>请尝试切换分类或稍后重试</p>
    {% if is_cached %}
    <p class="cache-hint">当前展示为缓存数据，<a href="javascript:void(0)" onclick="refreshData()">点击刷新</a>获取最新榜单</p>
    {% endif %}
</section>
{% endif %}

<!-- Quick Link to Awards -->
<nav class="quick-link-section" aria-label="快速链接">
    <a href="{{ url_for('main.awards') }}" class="quick-link-card">
        <i class="fa fa-trophy" aria-hidden="true"></i>
        <div>
            <h3>查看国际图书奖项榜单</h3>
            <p>诺贝尔文学奖、布克奖、普利策奖等</p>
        </div>
        <i class="fa fa-arrow-right" aria-hidden="true"></i>
    </a>
</nav>

<!-- Book Detail Modal -->
<div class="modal" id="book-modal" onclick="closeBookModal(event)" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-content" onclick="event.stopPropagation()" role="document">
        <button class="modal-close" onclick="closeBookModal()" aria-label="关闭详情">
            <i class="fa fa-times" aria-hidden="true"></i>
        </button>

        <div class="modal-body">
            <div class="modal-left">
                <div class="modal-cover">
                    <img id="modal-cover-img" src="" alt="" width="300" height="450">
                    <div class="modal-rank" id="modal-rank" aria-label="排名"></div>
                </div>

                <div class="modal-buy-links" id="modal-buy-links" aria-label="购买链接">
                    <h4>购买链接</h4>
                    <div class="buy-links-list" id="buy-links-list"></div>
                </div>
            </div>

            <div class="modal-right">
                <div class="modal-header">
                    <h2 id="modal-title"></h2>
                    <p class="modal-author" id="modal-author"></p>
                </div>

                <dl class="modal-meta" aria-label="图书信息">
                    <div class="meta-item">
                        <dt class="meta-label">出版社</dt>
                        <dd class="meta-value" id="modal-publisher"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">出版日期</dt>
                        <dd class="meta-value" id="modal-publication-date"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">页数</dt>
                        <dd class="meta-value" id="modal-page-count"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">语言</dt>
                        <dd class="meta-value" id="modal-language"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">分类</dt>
                        <dd class="meta-value" id="modal-category"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">上榜周数</dt>
                        <dd class="meta-value" id="modal-weeks-on-list"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">上周排名</dt>
                        <dd class="meta-value" id="modal-rank-last-week"></dd>
                    </div>
                    <div class="meta-item">
                        <dt class="meta-label">ISBN-13</dt>
                        <dd class="meta-value" id="modal-isbn"></dd>
                    </div>
                </dl>

                <nav class="modal-tabs" role="tablist" aria-label="详情标签页">
                    <button class="tab-btn active" role="tab" id="tab-description-btn" aria-selected="true" aria-controls="tab-description" onclick="switchTab('description')">图书简介</button>
                    <button class="tab-btn" role="tab" id="tab-details-btn" aria-selected="false" aria-controls="tab-details" onclick="switchTab('details')">详细信息</button>
                </nav>

                <div class="modal-tab-content">
                    <div class="tab-panel active" id="tab-description" role="tabpanel" aria-labelledby="tab-description-btn">
                        <p id="modal-description"></p>
                    </div>
                    <div class="tab-panel" id="tab-details" role="tabpanel" aria-labelledby="tab-details-btn">
                        <div id="modal-details-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Books Data for JavaScript -->
<script type="application/json" id="books-data">
{{ books|tojson }}
</script>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { api } from '{{ url_for('static', filename='js/api.js') }}';
    window.api = api;
</script>
<script>
    // Parse books data safely
    window.booksData = JSON.parse(document.getElementById('books-data').textContent);

    // ========== 无感翻译系统 ==========
    
    // 当前语言偏好
    let currentLanguage = localStorage.getItem('bookrank_language') || 'en';
    
    // 翻译缓存系统
    let translationCache = {
        // 格式: { isbn: { title_zh: "...", desc_zh: "...", original: {...} } }
        books: {},
        // 保存到 localStorage
        save() {
            try {
                localStorage.setItem('bookrank_translation_cache', JSON.stringify(this.books));
            } catch (e) {
                console.warn('无法保存翻译缓存:', e);
            }
        },
        // 从 localStorage 加载
        load() {
            try {
                const cached = localStorage.getItem('bookrank_translation_cache');
                if (cached) {
                    this.books = JSON.parse(cached);
                }
            } catch (e) {
                console.warn('无法加载翻译缓存:', e);
            }
        },
        // 获取图书的翻译
        getBook(isbn) {
            return this.books[isbn];
        },
        // 保存图书的翻译
        setBook(isbn, data) {
            this.books[isbn] = {
                ...data,
                timestamp: Date.now()
            };
            this.save();
        }
    };
    
    // 页面加载时加载翻译缓存
    translationCache.load();
    
    // ========== 语言切换器 ==========
    
    /**
     * 切换语言
     * @param {string} lang - 'en' 或 'zh'
     */
    async function switchLanguage(lang) {
        if (lang === currentLanguage) return;
        
        // 更新按钮状态
        updateLanguageButtons(lang);
        
        // 保存到 localStorage
        currentLanguage = lang;
        localStorage.setItem('bookrank_language', lang);
        
        if (lang === 'zh') {
            showToast('正在切换到中文...', 'info');
            await translateAllBooks();
        } else {
            showToast('已切换到英文', 'success');
            restoreAllBooks();
        }
    }
    
    /**
     * 更新语言按钮状态
     */
    function updateLanguageButtons(activeLang) {
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        const activeBtn = document.getElementById(`lang-${activeLang}`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // ========== 翻译核心功能 ==========
    
    /**
     * 批量翻译所有图书
     */
    async function translateAllBooks() {
        const books = window.booksData;
        let translatedCount = 0;
        
        // 先应用已缓存的翻译
        for (let i = 0; i < books.length; i++) {
            const book = books[i];
            const isbn = book.isbn13 || book.isbn10;
            
            if (isbn) {
                const cached = translationCache.getBook(isbn);
                if (cached && cached.title_zh) {
                    applyTranslationToCard(i, cached);
                    translatedCount++;
                }
            }
        }
        
        if (translatedCount > 0) {
            showToast(`已加载 ${translatedCount} 本缓存翻译`, 'info');
        }
        
        // 批量翻译未缓存的图书（最多10本，避免API限制）
        let toTranslate = [];
        for (let i = 0; i < books.length && toTranslate.length < 10; i++) {
            const book = books[i];
            const isbn = book.isbn13 || book.isbn10;
            
            if (isbn) {
                const cached = translationCache.getBook(isbn);
                if (!cached || !cached.title_zh) {
                    toTranslate.push({ index: i, book, isbn });
                }
            }
        }
        
        // 逐个翻译剩余的
        for (const { index, book, isbn } of toTranslate) {
            await translateSingleBook(index, book, isbn);
        }
        
        showToast('中文翻译已准备好！', 'success');
    }
    
    /**
     * 翻译单本图书
     */
    async function translateSingleBook(index, book, isbn) {
        try {
            let translatedTitle = book.title;
            let translatedDesc = book.description;
            
            // 翻译标题
            if (book.title) {
                try {
                    const result = await api.translateText(book.title);
                    if (result.success) {
                        translatedTitle = result.data.translated;
                    }
                } catch (e) {
                    console.log('标题翻译失败:', e);
                }
            }
            
            // 翻译描述
            if (book.description) {
                try {
                    const result = await api.translateText(book.description);
                    if (result.success) {
                        translatedDesc = result.data.translated;
                    }
                } catch (e) {
                    console.log('描述翻译失败:', e);
                }
            }
            
            const translatedData = {
                title_zh: translatedTitle,
                desc_zh: translatedDesc,
                original_title: book.title,
                original_desc: book.description
            };
            
            // 保存到缓存
            if (isbn) {
                translationCache.setBook(isbn, translatedData);
            }
            
            // 应用到卡片
            applyTranslationToCard(index, translatedData);
            
        } catch (error) {
            console.error('翻译失败:', error);
        }
    }
    
    /**
     * 应用翻译到单个卡片
     */
    function applyTranslationToCard(index, data) {
        const cards = document.querySelectorAll('.card');
        const listItems = document.querySelectorAll('.list-item');
        
        // 更新网格视图
        if (cards[index]) {
            const titleEl = cards[index].querySelector('.card-title');
            const descEl = cards[index].querySelector('.card-desc');
            
            if (titleEl) {
                titleEl.textContent = data.title_zh;
                titleEl.title = data.title_zh;
                // 添加翻译标识
                if (!titleEl.querySelector('.translation-badge')) {
                    titleEl.insertAdjacentHTML('beforeend', '<span class="translation-badge">译</span>');
                }
            }
            if (descEl && data.desc_zh) {
                const shortDesc = data.desc_zh.slice(0, 100) + 
                    (data.desc_zh.length > 100 ? '...' : '');
                descEl.textContent = shortDesc;
            }
        }
        
        // 更新列表视图
        if (listItems[index]) {
            const titleEl = listItems[index].querySelector('.list-item-title');
            const descEl = listItems[index].querySelector('.list-item-desc');
            
            if (titleEl) {
                titleEl.textContent = data.title_zh;
            }
            if (descEl && data.desc_zh) {
                const shortDesc = data.desc_zh.slice(0, 200) + 
                    (data.desc_zh.length > 200 ? '...' : '');
                descEl.textContent = shortDesc;
            }
        }
    }
    
    /**
     * 恢复所有图书到原始版本
     */
    function restoreAllBooks() {
        const books = window.booksData;
        
        for (let i = 0; i < books.length; i++) {
            const book = books[i];
            const cards = document.querySelectorAll('.card');
            const listItems = document.querySelectorAll('.list-item');
            
            // 恢复网格视图
            if (cards[i]) {
                const titleEl = cards[i].querySelector('.card-title');
                const descEl = cards[i].querySelector('.card-desc');
                
                if (titleEl) {
                    titleEl.textContent = book.title;
                    titleEl.title = book.title;
                    // 移除翻译标识
                    const badge = titleEl.querySelector('.translation-badge');
                    if (badge) badge.remove();
                }
                if (descEl && book.description) {
                    const shortDesc = book.description.slice(0, 100) + 
                        (book.description.length > 100 ? '...' : '');
                    descEl.textContent = shortDesc;
                }
            }
            
            // 恢复列表视图
            if (listItems[i]) {
                const titleEl = listItems[i].querySelector('.list-item-title');
                const descEl = listItems[i].querySelector('.list-item-desc');
                
                if (titleEl) {
                    titleEl.textContent = book.title;
                }
                if (descEl && book.description) {
                    const shortDesc = book.description.slice(0, 200) + 
                        (book.description.length > 200 ? '...' : '');
                    descEl.textContent = shortDesc;
                }
            }
        }
    }
    
    // ========== 模态框翻译 ==========
    
    // 保存当前打开的图书索引
    let currentModalBookIndex = -1;
    
    // 重写 openBookModal
    const originalOpenBookModal = openBookModal;
    window.openBookModal = function(bookIndex) {
        currentModalBookIndex = bookIndex;
        originalOpenBookModal(bookIndex);
        
        // 如果是中文模式，自动翻译模态框内容
        if (currentLanguage === 'zh') {
            translateModalContent(bookIndex);
        }
    };
    
    /**
     * 翻译模态框内容
     */
    async function translateModalContent(bookIndex) {
        const book = window.booksData[bookIndex];
        if (!book) return;
        
        const isbn = book.isbn13 || book.isbn10;
        
        // 检查缓存
        let translatedData = null;
        if (isbn) {
            translatedData = translationCache.getBook(isbn);
        }
        
        // 如果没有缓存，就翻译
        if (!translatedData || !translatedData.title_zh) {
            await translateSingleBook(bookIndex, book, isbn);
            translatedData = isbn ? translationCache.getBook(isbn) : null;
        }
        
        // 应用翻译到模态框
        if (translatedData) {
            const titleEl = document.getElementById('modal-title');
            const descEl = document.getElementById('modal-description');
            
            if (titleEl) {
                titleEl.textContent = translatedData.title_zh;
            }
            if (descEl && translatedData.desc_zh) {
                descEl.textContent = translatedData.desc_zh;
            }
        }
    }
    
    // ========== 初始化 ==========
    
    // 页面加载时应用保存的语言偏好
    document.addEventListener('DOMContentLoaded', function() {
        // 更新语言按钮
        updateLanguageButtons(currentLanguage);
        
        // 如果是中文模式，自动翻译
        if (currentLanguage === 'zh') {
            // 延迟一点，确保 DOM 完全加载
            setTimeout(() => {
                translateAllBooks();
            }, 500);
        }
    });

    // ========== 原有功能保持不变 ==========

    // Change category
    function changeCategory(category) {
        showLoading('加载中...');
        window.location.href = `/?category=${encodeURIComponent(category)}`;
    }

    // Apply filters
    function applyFilters() {
        const category = document.getElementById('category-select').value;
        const search = document.getElementById('search-input').value;

        showLoading('搜索中...');

        let url = `/?category=${encodeURIComponent(category)}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }

        window.location.href = url;
    }

    // Refresh data
    function refreshData() {
        showLoading('刷新中...');
        window.location.href = window.location.pathname + '?refresh=1';
    }

    // Export books to CSV
    function exportBooks(category) {
        showToast('正在导出...', 'info');
        window.location.href = `/api/export/${encodeURIComponent(category)}`;
    }

    // Helper function: Escape HTML to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Helper function: Get best description
    function getBestDescription(book) {
        const hasDetails = book.details && book.details.length > 50;
        const hasDescription = book.description && book.description.length > 50;

        if (hasDetails && hasDescription) {
            return book.details.length > book.description.length ? book.details : book.description;
        }

        if (hasDetails) return book.details;
        if (hasDescription) return book.description;

        return '暂无详细描述';
    }

    // Helper function: Build detail item HTML (with XSS protection)
    function buildDetailItem(label, value) {
        return `
            <div class="detail-item">
                <span class="detail-label">${escapeHtml(label)}</span>
                <span class="detail-value">${escapeHtml(value) || '暂无'}</span>
            </div>
        `;
    }

    // Helper function: Render buy links
    function renderBuyLinks(container, buyLinks) {
        container.innerHTML = '';
        if (!buyLinks || buyLinks.length === 0) {
            container.innerHTML = '<p class="no-links">暂无购买链接</p>';
            return;
        }

        buyLinks.forEach(link => {
            if (!link.url) return;
            const a = document.createElement('a');
            a.href = link.url;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.className = 'buy-link';
            a.innerHTML = `<i class="fa fa-external-link" aria-hidden="true"></i> ${link.name || '购买链接'}`;
            a.setAttribute('aria-label', `在 ${link.name} 上购买`);
            container.appendChild(a);
        });
    }

    // Book Modal Functions
    async function openBookModal(bookIndex) {
        const book = window.booksData[bookIndex];
        if (!book) return;

        // Fill modal content
        const coverImg = document.getElementById('modal-cover-img');
        coverImg.src = book.cover || '/static/default-cover.png';
        coverImg.alt = book.title + '封面';

        document.getElementById('modal-rank').textContent = bookIndex + 1;
        document.getElementById('modal-title').textContent = book.title || '';
        document.getElementById('modal-author').textContent = book.author || '';
        document.getElementById('modal-publisher').textContent = book.publisher || '未知';
        document.getElementById('modal-publication-date').textContent = book.publication_dt || '未知';
        document.getElementById('modal-page-count').textContent = book.page_count || '未知';
        document.getElementById('modal-language').textContent = book.language || '未知';
        document.getElementById('modal-category').textContent = book.category_name || '';
        document.getElementById('modal-weeks-on-list').textContent = book.weeks_on_list ? `${book.weeks_on_list}周` : '未知';
        document.getElementById('modal-rank-last-week').textContent = book.rank_last_week || 'NEW';
        document.getElementById('modal-isbn').textContent = book.isbn13 || '';

        // Description tab
        document.getElementById('modal-description').textContent = book.description || '暂无简介';

        // Details tab (with XSS protection)
        const detailsContent = document.getElementById('modal-details-content');
        detailsContent.innerHTML = `
            <div class="details-section">
                <p id="modal-detail-description" class="book-full-description">${escapeHtml(getBestDescription(book))}</p>
                <p id="modal-detail-loading" class="loading-text" style="display: none; color: #999; font-style: italic;">正在获取详细介绍...</p>
            </div>
        `;

        // Buy links
        renderBuyLinks(document.getElementById('buy-links-list'), book.buy_links);

        // Show modal
        const modal = document.getElementById('book-modal');
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        // Focus first focusable element
        modal.querySelector('.modal-close').focus();

        // Fetch additional details from Google Books API
        if (book.isbn13) {
            await fetchBookDetails(book.isbn13, bookIndex);
        }
    }

    // Fetch book details from API
    async function fetchBookDetails(isbn, bookIndex) {
        const loadingEl = document.getElementById('modal-detail-loading');
        const descriptionEl = document.getElementById('modal-detail-description');

        try {
            if (loadingEl) loadingEl.style.display = 'block';

            const response = await fetch(`/api/book-details/${isbn}`);
            const data = await response.json();

            if (data.success && data.data) {
                const googleData = data.data;

                // Update description if more detailed content available
                if (googleData.details && googleData.details.length > 50) {
                    descriptionEl.textContent = googleData.details;
                    descriptionEl.classList.add('updated');
                }

                // Update buy links
                if (googleData.buy_links && Object.keys(googleData.buy_links).length > 0) {
                    const buyLinksArray = Object.entries(googleData.buy_links).map(([name, url]) => ({
                        name: name,
                        url: url
                    }));
                    renderBuyLinks(document.getElementById('buy-links-list'), buyLinksArray);
                }
            }
        } catch (error) {
            console.log('获取 Google Books 详情失败:', error);
        } finally {
            if (loadingEl) loadingEl.style.display = 'none';
        }
    }

    function closeBookModal(event) {
        const modal = document.getElementById('book-modal');
        if (!event || event.target.id === 'book-modal' || event.target.closest('.modal-close')) {
            modal.classList.remove('active');
            modal.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
        }
    }

    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });

        const activeBtn = event.target;
        activeBtn.classList.add('active');
        activeBtn.setAttribute('aria-selected', 'true');

        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        const activePanel = document.getElementById(`tab-${tabName}`);
        activePanel.classList.add('active');
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeBookModal();
        }
    });

    // 移除之前的单个翻译按钮功能，改用批量翻译
    // Keyboard accessibility for cards
    document.querySelectorAll('.card, .list-item').forEach(item => {
        item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
</script>
{% endblock %}

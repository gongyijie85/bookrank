{% extends "base.html" %}

{% block title %}纽约时报畅销书排行榜 - BookRank{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">
        <i class="fa fa-fire text-gold"></i>
        纽约时报畅销书排行榜
    </h1>
    <p class="page-subtitle">
        <i class="fa fa-clock-o"></i>
        更新于: {{ update_time if update_time else '刚刚' }}
        {% if is_cached %}
        <span class="cache-badge">缓存数据</span>
        {% endif %}
    </p>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-group">
        <label class="filter-label">图书分类</label>
        <select class="filter-select" id="category-select" onchange="changeCategory(this.value)">
            {% for key, label in categories.items() %}
            <option value="{{ key }}" {% if key == current_category %}selected{% endif %}>
                {{ label }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group search-box">
        <label class="filter-label">搜索</label>
        <div class="search-input-wrapper">
            <input type="text" 
                   class="filter-input" 
                   id="search-input"
                   placeholder="搜索书名或作者..."
                   value="{{ search_query if search_query else '' }}">
            <i class="fa fa-search"></i>
        </div>
    </div>
    
    <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fa fa-filter"></i>
            筛选
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()">
            <i class="fa fa-refresh"></i>
            重置
        </button>
    </div>
    
    <div class="view-toggle">
        <button class="btn btn-icon {% if view_mode == 'grid' %}active{% endif %}" 
                id="view-grid"
                onclick="toggleView('grid')"
                title="网格视图">
            <i class="fa fa-th"></i>
        </button>
        <button class="btn btn-icon {% if view_mode == 'list' or not view_mode %}active{% endif %}" 
                id="view-list"
                onclick="toggleView('list')"
                title="列表视图">
            <i class="fa fa-list"></i>
        </button>
    </div>
</div>

<!-- Export Actions Bar -->
{% if books %}
<div class="export-actions-bar">
    <span class="export-info">共 {{ books|length }} 本图书</span>
    <div class="export-buttons">
        <button class="btn btn-primary btn-sm" onclick="exportBooks('{{ current_category }}')">
            <i class="fa fa-download"></i>
            导出当前分类
        </button>
        <button class="btn btn-secondary btn-sm" onclick="exportBooks('all')">
            <i class="fa fa-download"></i>
            导出全部
        </button>
    </div>
</div>
{% endif %}

<!-- Books Grid View -->
<div class="books-grid" id="books-grid" style="display: {% if view_mode == 'grid' %}grid{% else %}none{% endif %}">
    {% for book in books %}
    <div class="card card-animate" style="animation-delay: {{ loop.index * 0.05 }}s" onclick="openBookModal({{ loop.index - 1 }})">
        <div class="card-image">
            <img src="{{ book.cover if book.cover else url_for('static', filename='default-cover.png') }}" 
                 alt="{{ book.title }}"
                 loading="lazy"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
            
            <!-- Category Tag - 分类标签 (左上角) -->
            <div class="card-category-tag">{{ book.category_name if book.category_name else '虚构类' }}</div>
            
            <!-- Rank Badge - 排名徽章 (右上角) -->
            <div class="card-badge {% if loop.index == 1 %}gold{% elif loop.index == 2 %}silver{% elif loop.index == 3 %}bronze{% else %}other{% endif %}">
                {{ loop.index }}
            </div>
            
            <!-- Rank Change Badge -->
            {% if book.rank_last_week and book.rank_last_week != '0' %}
                {% set rank_change = book.rank_last_week|int - loop.index %}
                {% if rank_change > 0 %}
                <div class="rank-change up">↑{{ rank_change }}</div>
                {% elif rank_change < 0 %}
                <div class="rank-change down">↓{{ rank_change|abs }}</div>
                {% endif %}
            {% elif book.rank_last_week == '0' or not book.rank_last_week %}
                <div class="rank-change new">NEW</div>
            {% endif %}
            
        </div>
        
        <div class="card-content">
            <div class="card-rank-row">
                <span class="card-rank-badge">第{{ loop.index }}名</span>
                {% if book.weeks_on_list %}
                <span class="card-weeks">
                    <i class="fa fa-clock-o"></i> {{ book.weeks_on_list }}周
                </span>
                {% endif %}
            </div>
            <h3 class="card-title" title="{{ book.title }}">{{ book.title }}</h3>
            <p class="card-author">{{ book.author }}</p>
            
            {% if book.description %}
            <p class="card-desc">{{ book.description[:100] }}{% if book.description|length > 100 %}...{% endif %}</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Books List View -->
<div class="books-list" id="books-list" style="display: {% if view_mode == 'list' or not view_mode %}flex{% else %}none{% endif %}">
    {% for book in books %}
    <div class="list-item card-animate" style="animation-delay: {{ loop.index * 0.05 }}s" onclick="openBookModal({{ loop.index - 1 }})">
        <div class="list-item-image">
            <img src="{{ book.cover if book.cover else url_for('static', filename='default-cover.png') }}" 
                 alt="{{ book.title }}"
                 loading="lazy"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
        </div>
        
        <div class="list-item-content">
            <div class="list-item-header">
                <div class="list-item-rank {% if loop.index == 1 %}rank-gold{% elif loop.index == 2 %}rank-silver{% elif loop.index == 3 %}rank-bronze{% endif %}">
                    {{ loop.index }}
                </div>
                
                <!-- Rank Change -->
                {% if book.rank_last_week and book.rank_last_week != '0' %}
                    {% set rank_change = book.rank_last_week|int - loop.index %}
                    {% if rank_change > 0 %}
                    <span class="rank-change-badge up">↑{{ rank_change }}</span>
                    {% elif rank_change < 0 %}
                    <span class="rank-change-badge down">↓{{ rank_change|abs }}</span>
                    {% endif %}
                {% elif book.rank_last_week == '0' or not book.rank_last_week %}
                    <span class="rank-change-badge new">NEW</span>
                {% endif %}
                
                <h3 class="list-item-title">{{ book.title }}</h3>
            </div>
            
            <p class="list-item-author">{{ book.author }}</p>
            
            {% if book.description %}
            <p class="list-item-desc">{{ book.description[:200] }}{% if book.description|length > 200 %}...{% endif %}</p>
            {% endif %}
            
            <div class="list-item-meta">
                <span class="card-tag">{{ book.category_name if book.category_name else '虚构类' }}</span>
                {% if book.weeks_on_list %}
                <span class="card-tag">
                    <i class="fa fa-clock-o"></i> {{ book.weeks_on_list }}周
                </span>
                {% endif %}
                {% if book.publisher %}
                <span class="card-tag">
                    <i class="fa fa-building"></i> {{ book.publisher }}
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="list-item-actions">
            <button class="btn btn-icon btn-outline" onclick="event.stopPropagation(); toggleFavorite(this, '{{ book.isbn13 }}')">
                <i class="fa fa-heart-o"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
{% if not books %}
<div class="empty-state">
    <i class="fa fa-inbox"></i>
    <h3>暂无数据</h3>
    <p>请尝试切换分类或稍后重试</p>
    {% if is_cached %}
    <p class="cache-hint">当前展示为缓存数据，<a href="javascript:void(0)" onclick="refreshData()">点击刷新</a>获取最新榜单</p>
    {% endif %}
</div>
{% endif %}

<!-- Quick Link to Awards -->
<div class="quick-link-section">
    <a href="{{ url_for('main.awards') }}" class="quick-link-card">
        <i class="fa fa-trophy"></i>
        <div>
            <h4>查看国际图书奖项榜单</h4>
            <p>诺贝尔文学奖、布克奖、普利策奖等</p>
        </div>
        <i class="fa fa-arrow-right"></i>
    </a>
</div>

<!-- Book Detail Modal -->
<div class="modal" id="book-modal" onclick="closeBookModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeBookModal()">
            <i class="fa fa-times"></i>
        </button>
        
        <div class="modal-body">
            <div class="modal-left">
                <div class="modal-cover">
                    <img id="modal-cover-img" src="" alt="">
                    <div class="modal-rank" id="modal-rank"></div>
                </div>
                
                <!-- Buy Links - 购买链接移到左下角 -->
                <div class="modal-buy-links" id="modal-buy-links">
                    <h4>购买链接</h4>
                    <div class="buy-links-list" id="buy-links-list"></div>
                </div>
            </div>
            
            <div class="modal-right">
                <div class="modal-header">
                    <h2 id="modal-title"></h2>
                    <p class="modal-author" id="modal-author"></p>
                </div>
                
                <div class="modal-meta">
                    <div class="meta-item">
                        <span class="meta-label">出版社</span>
                        <span class="meta-value" id="modal-publisher"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">出版日期</span>
                        <span class="meta-value" id="modal-publication-date"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">页数</span>
                        <span class="meta-value" id="modal-page-count"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">语言</span>
                        <span class="meta-value" id="modal-language"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">分类</span>
                        <span class="meta-value" id="modal-category"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">上榜周数</span>
                        <span class="meta-value" id="modal-weeks-on-list"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">上周排名</span>
                        <span class="meta-value" id="modal-rank-last-week"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ISBN-13</span>
                        <span class="meta-value" id="modal-isbn"></span>
                    </div>
                </div>
                
                <div class="modal-tabs">
                    <button class="tab-btn active" onclick="switchTab('description')">图书简介</button>
                    <button class="tab-btn" onclick="switchTab('details')">详细信息</button>
                </div>
                
                <div class="modal-tab-content">
                    <div class="tab-panel active" id="tab-description">
                        <p id="modal-description"></p>
                    </div>
                    <div class="tab-panel" id="tab-details">
                        <div id="modal-details-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Books Data for JavaScript -->
<script>
    window.booksData = {{ books|tojson|safe }};
</script>
{% endblock %}

{% block extra_js %}
<script>
    // Change category
    function changeCategory(category) {
        showLoading('加载中...');
        window.location.href = `/?category=${category}`;
    }
    
    // Apply filters
    function applyFilters() {
        const category = document.getElementById('category-select').value;
        const search = document.getElementById('search-input').value;
        
        showLoading('搜索中...');
        
        let url = `/?category=${category}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        window.location.href = url;
    }
    
    // Refresh data
    function refreshData() {
        showLoading('刷新中...');
        window.location.href = window.location.pathname + '?refresh=1';
    }
    
    // Export books to CSV - 直接调用后端API导出
    function exportBooks(category) {
        showToast('正在导出...', 'info');
        window.location.href = `/api/export/${category}`;
    }
    
    // Helper function: Get best description
    function getBestDescription(book) {
        // 对于畅销书，优先使用 description（NYT API 数据）
        // 对于奖项图书，优先使用 details（Google Books 数据）
        const hasDetails = book.details && book.details.length > 50;
        const hasDescription = book.description && book.description.length > 50;
        
        if (hasDetails && hasDescription) {
            // 两者都有，返回更详细的那个
            return book.details.length > book.description.length ? book.details : book.description;
        }
        
        if (hasDetails) {
            return book.details;
        }
        
        if (hasDescription) {
            return book.description;
        }
        
        return '暂无详细描述';
    }
    
    // Helper function: Build detail item HTML
    function buildDetailItem(label, value) {
        return `
            <div class="detail-item">
                <span class="detail-label">${label}</span>
                <span class="detail-value">${value || '暂无'}</span>
            </div>
        `;
    }
    
    // Helper function: Render buy links
    function renderBuyLinks(container, buyLinks) {
        container.innerHTML = '';
        if (!buyLinks || buyLinks.length === 0) {
            container.innerHTML = '<p class="no-links">暂无购买链接</p>';
            return;
        }
        
        buyLinks.forEach(link => {
            if (!link.url) return;
            const a = document.createElement('a');
            a.href = link.url;
            a.target = '_blank';
            a.className = 'buy-link';
            a.innerHTML = `<i class="fa fa-external-link"></i> ${link.name || '购买链接'}`;
            container.appendChild(a);
        });
    }
    
    // Book Modal Functions
    async function openBookModal(bookIndex) {
        const book = window.booksData[bookIndex];
        if (!book) return;
        
        // Fill modal content
        document.getElementById('modal-cover-img').src = book.cover || '/static/default-cover.png';
        document.getElementById('modal-rank').textContent = bookIndex + 1;
        document.getElementById('modal-title').textContent = book.title || '';
        document.getElementById('modal-author').textContent = book.author || '';
        document.getElementById('modal-publisher').textContent = book.publisher || '未知';
        document.getElementById('modal-publication-date').textContent = book.publication_dt || '未知';
        document.getElementById('modal-page-count').textContent = book.page_count || '未知';
        document.getElementById('modal-language').textContent = book.language || '未知';
        document.getElementById('modal-category').textContent = book.category_name || '';
        document.getElementById('modal-weeks-on-list').textContent = book.weeks_on_list ? `${book.weeks_on_list}周` : '未知';
        document.getElementById('modal-rank-last-week').textContent = book.rank_last_week || 'NEW';
        document.getElementById('modal-isbn').textContent = book.isbn13 || '';
        
        // 图书简介标签页
        document.getElementById('modal-description').textContent = book.description || '暂无简介';
        
        // 详细信息标签页 - 只显示图书详细介绍
        const detailsContent = document.getElementById('modal-details-content');
        detailsContent.innerHTML = `
            <div class="details-section">
                <h4>图书简介</h4>
                <p id="modal-detail-description" class="book-full-description">${getBestDescription(book)}</p>
            </div>
        `;
        
        // Buy links
        renderBuyLinks(document.getElementById('buy-links-list'), book.buy_links);
        
        // Show modal
        document.getElementById('book-modal').classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // 异步获取 Google Books 详细信息
        if (book.isbn13) {
            try {
                const response = await fetch(`/api/book-details/${book.isbn13}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const googleData = data.data;
                    
                    // 更新详细信息
                    if (googleData.details && googleData.details.length > 50) {
                        document.getElementById('modal-detail-description').textContent = googleData.details;
                    }
                    
                    // 更新购买链接
                    if (googleData.buy_links && Object.keys(googleData.buy_links).length > 0) {
                        const buyLinksArray = Object.entries(googleData.buy_links).map(([name, url]) => ({
                            name: name,
                            url: url
                        }));
                        renderBuyLinks(document.getElementById('buy-links-list'), buyLinksArray);
                    }
                    
                    // 更新其他字段（如果有）
                    if (googleData.page_count) {
                        document.getElementById('modal-page-count').textContent = googleData.page_count;
                    }
                    if (googleData.language) {
                        document.getElementById('modal-language').textContent = googleData.language;
                    }
                    if (googleData.publisher) {
                        document.getElementById('modal-publisher').textContent = googleData.publisher;
                    }
                }
            } catch (error) {
                console.log('Failed to fetch Google Books details:', error);
            }
        }
    }
    
    function closeBookModal(event) {
        if (!event || event.target.id === 'book-modal' || event.target.closest('.modal-close')) {
            document.getElementById('book-modal').classList.remove('active');
            document.body.style.overflow = '';
        }
    }
    
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeBookModal();
        }
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}国际图书奖项榜单 - BookRank{% endblock %}

{% block sidebar %}
<div class="sidebar-section">
    <h3 class="sidebar-title">奖项分类</h3>
    <ul class="sidebar-menu">
        <li class="sidebar-item">
            <a href="{{ url_for('main.awards') }}" 
               class="sidebar-link {% if not selected_award %}active{% endif %}">
                <i class="fa fa-list"></i>
                <span>全部奖项</span>
            </a>
        </li>
        {% for award in awards %}
        <li class="sidebar-item">
            <a href="{{ url_for('main.awards', award=award.name) }}" 
               class="sidebar-link {% if selected_award == award.name %}active{% endif %}">
                <i class="fa fa-trophy"></i>
                <span>{{ award.name }}</span>
            </a>
        </li>
        {% endfor %}
    </ul>
</div>

<div class="sidebar-section">
    <h3 class="sidebar-title">年份筛选</h3>
    <ul class="sidebar-menu">
        <li class="sidebar-item">
            <a href="{{ url_for('main.awards', award=selected_award) }}" 
               class="sidebar-link {% if not selected_year %}active{% endif %}">
                <i class="fa fa-calendar"></i>
                <span>全部年份</span>
            </a>
        </li>
        {% for year in years %}
        <li class="sidebar-item">
            <a href="{{ url_for('main.awards', award=selected_award, year=year) }}" 
               class="sidebar-link {% if selected_year == year %}active{% endif %}">
                <i class="fa fa-calendar-o"></i>
                <span>{{ year }}年</span>
            </a>
        </li>
        {% endfor %}
    </ul>
</div>

<div class="sidebar-section">
    <h3 class="sidebar-title">统计信息</h3>
    <div class="sidebar-stats">
        <div class="stat-item">
            <span class="stat-value">{{ total_books }}</span>
            <span class="stat-label">本图书</span>
        </div>
        <div class="stat-item">
            <span class="stat-value">{{ awards|length }}</span>
            <span class="stat-label">个奖项</span>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">
        <i class="fa fa-trophy text-gold"></i>
        {% if selected_award %}
            {{ selected_award }}
        {% else %}
            国际图书奖项榜单
        {% endif %}
    </h1>
    <p class="page-subtitle">
        {% if selected_award %}
            {{ selected_award }}获奖图书展示
        {% else %}
            汇集全球最具影响力的图书奖项
        {% endif %}
        {% if selected_year %}
            · {{ selected_year }}年
        {% endif %}
    </p>
</div>

<!-- Filter Bar -->
<div class="filter-bar">
    <div class="filter-group">
        <label class="filter-label">奖项</label>
        <select class="filter-select" id="award-select" onchange="changeAward(this.value)">
            <option value="">全部奖项</option>
            {% for award in awards %}
            <option value="{{ award.name }}" {% if selected_award == award.name %}selected{% endif %}>
                {{ award.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group">
        <label class="filter-label">年份</label>
        <select class="filter-select" id="year-select" onchange="changeYear(this.value)">
            <option value="">全部年份</option>
            {% for year in years %}
            <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>
                {{ year }}年
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="filter-group search-box">
        <label class="filter-label">搜索</label>
        <div class="search-input-wrapper">
            <input type="text" 
                   class="filter-input" 
                   id="search-input"
                   placeholder="搜索书名或作者..."
                   value="{{ search_query if search_query else '' }}">
            <i class="fa fa-search"></i>
        </div>
    </div>
    
    <div class="filter-actions">
        <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fa fa-filter"></i>
            筛选
        </button>
        <button class="btn btn-secondary" onclick="clearFilters()">
            <i class="fa fa-refresh"></i>
            重置
        </button>
    </div>
    
    <div class="view-toggle">
        <button class="btn btn-icon {% if view_mode == 'grid' or not view_mode %}active{% endif %}" 
                id="view-grid"
                onclick="toggleView('grid')"
                title="网格视图">
            <i class="fa fa-th"></i>
        </button>
        <button class="btn btn-icon {% if view_mode == 'list' %}active{% endif %}" 
                id="view-list"
                onclick="toggleView('list')"
                title="列表视图">
            <i class="fa fa-list"></i>
        </button>
    </div>
</div>

<!-- Awards Info Cards -->
{% if not selected_award %}
<div class="awards-grid">
    {% for award in awards %}
    <a href="{{ url_for('main.awards', award=award.name) }}" class="award-card card-animate" style="animation-delay: {{ loop.index * 0.05 }}s">
        <div class="award-icon">
            <i class="fa fa-trophy"></i>
        </div>
        <div class="award-info">
            <h3>{{ award.name }}</h3>
            <p>{{ award.description[:60] }}{% if award.description|length > 60 %}...{% endif %}</p>
            <div class="award-meta">
                <span class="award-country">{{ award.country }}</span>
                <span class="award-count">{{ award.book_count }}本图书</span>
            </div>
        </div>
    </a>
    {% endfor %}
</div>
{% endif %}

<!-- Books Grid View -->
<div class="books-grid" id="books-grid" style="display: {% if view_mode == 'grid' or not view_mode %}grid{% else %}none{% endif %}">
    {% for book in books %}
    <div class="card card-animate" style="animation-delay: {{ loop.index * 0.05 }}s">
        <div class="card-image">
            <img src="{{ book.cover_local_path if book.cover_local_path else url_for('static', filename='default-cover.png') }}" 
                 alt="{{ book.title }}"
                 loading="lazy"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
            
            <!-- Award Badge -->
            <div class="card-badge award">
                <i class="fa fa-trophy"></i>
            </div>
            
            <!-- Year Badge -->
            <div class="card-badge year">{{ book.year }}</div>
            
            <!-- Favorite Button -->
            <button class="card-favorite" onclick="toggleFavorite(this, '{{ book.id }}')">
                <i class="fa fa-heart-o"></i>
            </button>
        </div>
        
        <div class="card-content">
            <div class="card-award-tag">{{ book.award_name }}</div>
            <h3 class="card-title" title="{{ book.title }}">{{ book.title }}</h3>
            <p class="card-author">{{ book.author }}</p>
            
            <div class="card-meta">
                <span class="card-tag">{{ book.category }}</span>
                <span class="card-tag">{{ book.year }}年</span>
            </div>
            
            {% if book.description %}
            <p class="card-desc">{{ book.description[:100] }}{% if book.description|length > 100 %}...{% endif %}</p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Books List View -->
<div class="books-list" id="books-list" style="display: {% if view_mode == 'list' %}flex{% else %}none{% endif %}">
    {% for book in books %}
    <div class="list-item card-animate" style="animation-delay: {{ loop.index * 0.05 }}s">
        <div class="list-item-image">
            <img src="{{ book.cover_local_path if book.cover_local_path else url_for('static', filename='default-cover.png') }}" 
                 alt="{{ book.title }}"
                 loading="lazy"
                 onerror="this.src='{{ url_for('static', filename='default-cover.png') }}'">
        </div>
        
        <div class="list-item-content">
            <div class="list-item-header">
                <span class="list-item-award">{{ book.award_name }}</span>
                <h3 class="list-item-title">{{ book.title }}</h3>
            </div>
            
            <p class="list-item-author">{{ book.author }}</p>
            
            {% if book.description %}
            <p class="list-item-desc">{{ book.description }}</p>
            {% endif %}
            
            <div class="list-item-meta">
                <span class="card-tag">{{ book.category }}</span>
                <span class="card-tag">{{ book.year }}年</span>
                {% if book.isbn13 %}
                <span class="card-tag">ISBN: {{ book.isbn13 }}</span>
                {% endif %}
            </div>
        </div>
        
        <div class="list-item-actions">
            <button class="btn btn-icon btn-outline" onclick="toggleFavorite(this, '{{ book.id }}')">
                <i class="fa fa-heart-o"></i>
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Empty State -->
{% if not books %}
<div class="empty-state">
    <i class="fa fa-inbox"></i>
    <h3>暂无数据</h3>
    <p>请尝试切换筛选条件或稍后重试</p>
</div>
{% endif %}

<!-- Quick Link to Bestsellers -->
<div class="quick-link-section">
    <a href="{{ url_for('main.index') }}" class="quick-link-card">
        <i class="fa fa-fire"></i>
        <div>
            <h4>查看纽约时报畅销书榜</h4>
            <p>实时更新的畅销图书排行榜</p>
        </div>
        <i class="fa fa-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Change award filter
    function changeAward(award) {
        showLoading('加载中...');
        const year = document.getElementById('year-select').value;
        let url = '/awards';
        if (award) url += `?award=${encodeURIComponent(award)}`;
        if (year) url += `${award ? '&' : '?'}year=${year}`;
        window.location.href = url;
    }
    
    // Change year filter
    function changeYear(year) {
        showLoading('加载中...');
        const award = document.getElementById('award-select').value;
        let url = '/awards';
        if (award) url += `?award=${encodeURIComponent(award)}`;
        if (year) url += `${award ? '&' : '?'}year=${year}`;
        window.location.href = url;
    }
    
    // Apply filters
    function applyFilters() {
        const award = document.getElementById('award-select').value;
        const year = document.getElementById('year-select').value;
        const search = document.getElementById('search-input').value;
        
        showLoading('搜索中...');
        
        let url = '/awards';
        const params = [];
        if (award) params.push(`award=${encodeURIComponent(award)}`);
        if (year) params.push(`year=${year}`);
        if (search) params.push(`search=${encodeURIComponent(search)}`);
        
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        window.location.href = url;
    }
    
    // Clear filters
    function clearFilters() {
        showLoading('重置中...');
        window.location.href = '/awards';
    }
    
    // Search on Enter key
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
</script>
{% endblock %}